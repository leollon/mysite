#!/bin/bash

set -o errexit

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NOCOLOR='\033[0m'

if [ -e './run' ]
then
    rm -f ./run/*
fi

mysql_ready() {
python << END
import sys
import MySQLdb


try:
    conn = MySQLdb.connect(
        db='${MYSQL_DATABASE}',
        host='${MYSQL_HOST}',
        port=${MYSQL_PORT},
        user='${MYSQL_USER}',
        password='${MYSQL_PASSWORD}'
    )
    print(conn.begin())
except MySQLdb.OperationalError:
    sys.exit(-1)
sys.exit(0)

END
}

until mysql_ready; do
    >&2 echo -e "${YELLOW}Waiting for MySQL to be available.....${NOCOLOR}"
    sleep 1
done
>&2 echo -e "${GREEN}MySQL is available!!!${NOCOLOR}"


exec "$@"
